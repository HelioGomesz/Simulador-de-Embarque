<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>teste.ConfiguraÃ§Ãµes2</title>
    <link rel="stylesheet" href="ajusteconfig.2.css" />
    <style></style>
  </head>
  <body>
    <header>
      <h1>ConfiguraÃ§Ãµes</h1>
      <nav>
        <ul>
          <li><a href="../simuladorDeEmbarque_7.0.1.html">ðŸšª Sair</a></li>
        </ul>
      </nav>
    </header>

    <main class="layout-principal">
      <div class="coluna-direita">
        <div class="listagemGeral container-centralizado">
          <div class="tabela-cupomEmbarque">
            <h2>Cadastro de Produtos</h2>
            <div class="filtros">
              <input
                type="text"
                id="filtroProduto"
                placeholder="Buscar produto/cÃ³digo..."
              />
              <select id="filtroTamanho">
                <option value="">Todos os Tamanhos</option>
                <option value="PP">PP</option>
                <option value="PG">PG</option>
              </select>
              <button onclick="filtrarTabela()">Filtrar</button>
              <button onclick="exportarParaExcel()">Exportar para Excel</button>
              <button onclick="restaurarDadosOriginais()">Resetar Dados</button>
              <button onclick="baixarBackup()">Backup JSON</button>
              <input
                type="file"
                id="importarBackup"
                onchange="importarBackup(event)"
              />
              <button class="btn-Incluir">Incluir</button>
            </div>
            <div id="totais">
              Quantidade Total: <span id="totalQuantidade">0</span> | Peso
              Total: <span id="totalPeso">0</span> kg | Cubagem Total:
              <span id="totalCubagem">0</span>
            </div>
            <br />
            <table>
              <thead>
                <tr>
                  <th>ID</th>
                  <th>Tamanho</th>
                  <th>Produto</th>
                  <th>Quantidade</th>
                  <th>Peso (kg)</th>
                  <th>Cubagem</th>
                  <th>AÃ§Ã£o</th>
                </tr>
              </thead>
              <tbody id="tabela-cupomList"></tbody>
            </table>
          </div>
        </div>
      </div>
    </main>

    <!-- Modal -->
    <div class="modal" id="modal">
      <div class="modal-header" id="modal-header">
        <h2>Adicionar Produto</h2>
      </div>
      <div class="modal-content">
        <select id="produto">
          <option value="" disabled selected>Selecione um produto</option>
          <option value="LM0001-4000840">LM0001-4000840</option>
          <option value="LM0001-4000850">LM0001-4000850</option>
        </select>
        <select id="tamanhoPallet">
          <option value="" disabled selected>
            Selecione o Tamanho do Pallet
          </option>
          <option value="PP">PP</option>
          <option value="PG">PG</option>
        </select>
        <input type="number" id="quantidade" placeholder="Quantidade" min="1" />
        <input type="number" id="peso" placeholder="Peso (kg)" min="1" />
        <input type="number" id="cubagem" placeholder="Cubagem" min="1" />
        <button onclick="addEntry()">Incluir</button>
        <button onclick="closeModal()">Cancelar</button>
      </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script>
      let listaProdutos = [];
      let idCounter = 1;

      function abrirCadastro() {
        document.getElementById("modal").style.display = "block";
      }

      function closeModal() {
        document.getElementById("modal").style.display = "none";
        limparCampos();
      }

      function limparCampos() {
        document.getElementById("produto").value = "";
        document.getElementById("tamanhoPallet").value = "";
        document.getElementById("quantidade").value = "";
        document.getElementById("peso").value = "";
        document.getElementById("cubagem").value = "";
      }

      function addEntry() {
        const produto = document.getElementById("produto").value;
        const tamanho = document.getElementById("tamanhoPallet").value;
        const quantidade = parseInt(
          document.getElementById("quantidade").value
        );
        const peso = parseFloat(document.getElementById("peso").value);
        const cubagem = parseFloat(document.getElementById("cubagem").value);

        if (!produto || !quantidade || !peso || !cubagem) {
          alert("Preencha todos os campos.");
          return;
        }

        const id = idCounter++;
        listaProdutos.push({ id, produto, tamanho, quantidade, peso, cubagem });
        salvarLocalStorage();
        atualizarTabela();
        closeModal();
      }

      function atualizarTabela() {
        const filtroTexto = document
          .getElementById("filtroProduto")
          .value.toLowerCase();
        const filtroTamanho = document.getElementById("filtroTamanho").value;

        const tabela = document.getElementById("tabela-cupomList");
        tabela.innerHTML = "";
        let totalQuantidade = 0,
          totalPeso = 0,
          totalCubagem = 0;

        listaProdutos
          .filter((item) => {
            return (
              (!filtroTexto ||
                item.produto.toLowerCase().includes(filtroTexto)) &&
              (!filtroTamanho || item.tamanho === filtroTamanho)
            );
          })
          .forEach((item) => {
            totalQuantidade += item.quantidade;
            totalPeso += item.peso;
            totalCubagem += item.cubagem;

            const tr = document.createElement("tr");
            tr.className = item.tamanho === "PP" ? "linha-pp" : "linha-pg";
            tr.innerHTML = `
            <td>${item.id}</td>
            <td>${item.tamanho}</td>
            <td>${item.produto}</td>
            <td>${item.quantidade}</td>
            <td>${item.peso}</td>
            <td>${item.cubagem}</td>
            <td>
              <button onclick="editarProduto(${item.id})">Editar</button>
              <button onclick="excluirProduto(${item.id})">Excluir</button>
            </td>
          `;
            tabela.appendChild(tr);
          });

        document.getElementById("totalQuantidade").textContent =
          totalQuantidade;
        document.getElementById("totalPeso").textContent = totalPeso.toFixed(2);
        document.getElementById("totalCubagem").textContent =
          totalCubagem.toFixed(2);
      }

      function filtrarTabela() {
        atualizarTabela();
      }

      function excluirProduto(id) {
        listaProdutos = listaProdutos.filter((item) => item.id !== id);
        salvarLocalStorage();
        atualizarTabela();
      }

      function editarProduto(id) {
        const item = listaProdutos.find((p) => p.id === id);
        if (!item) return;

        document.getElementById("produto").value = item.produto;
        document.getElementById("tamanhoPallet").value = item.tamanho;
        document.getElementById("quantidade").value = item.quantidade;
        document.getElementById("peso").value = item.peso;
        document.getElementById("cubagem").value = item.cubagem;

        listaProdutos = listaProdutos.filter((p) => p.id !== id);
        salvarLocalStorage();
        abrirCadastro();
      }

      function salvarLocalStorage() {
        localStorage.setItem("produtosCadastro", JSON.stringify(listaProdutos));
        localStorage.setItem("contadorId", idCounter);
      }

      function carregarLocalStorage() {
        const dadosSalvos = localStorage.getItem("produtosCadastro");
        const contadorSalvo = localStorage.getItem("contadorId");

        if (dadosSalvos) listaProdutos = JSON.parse(dadosSalvos);
        if (contadorSalvo) idCounter = parseInt(contadorSalvo);
        atualizarTabela();
      }

      function restaurarDadosOriginais() {
        localStorage.removeItem("produtosCadastro");
        localStorage.removeItem("contadorId");
        listaProdutos = [];
        idCounter = 1;
        atualizarTabela();
      }

      function exportarParaExcel() {
        const tabela = document.getElementById("tabela-cupomList");
        const rows = Array.from(tabela.rows).map((row) => {
          return Array.from(row.cells).map((cell) => cell.textContent);
        });
        const ws = XLSX.utils.aoa_to_sheet([
          ["ID", "Tamanho", "Produto", "Quantidade", "Peso (kg)", "Cubagem"],
          ...rows,
        ]);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Produtos");
        const dataAtual = new Date()
          .toLocaleDateString("pt-BR")
          .replace(/\//g, "-");
        XLSX.writeFile(wb, `produtos_${dataAtual}.xlsx`);
      }

      function baixarBackup() {
        const blob = new Blob([JSON.stringify(listaProdutos)], {
          type: "application/json",
        });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = "backup_produtos.json";
        a.click();
      }

      function importarBackup(event) {
        const file = event.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = function (e) {
          try {
            listaProdutos = JSON.parse(e.target.result);
            idCounter =
              listaProdutos.length > 0
                ? Math.max(...listaProdutos.map((p) => p.id)) + 1
                : 1;
            salvarLocalStorage();
            atualizarTabela();
          } catch {
            alert("Erro ao importar backup.");
          }
        };
        reader.readAsText(file);
      }

      window.onload = function () {
        document.querySelector(".btn-Incluir").onclick = abrirCadastro;
        carregarLocalStorage();
      };
    </script>
  </body>
</html>
